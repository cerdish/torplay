<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		
		<link rel="stylesheet" href="css/normalize.css" type="text/css">
		<link href='https://fonts.googleapis.com/icon?family=Material+Icons' rel='stylesheet'>
		<link rel="stylesheet" href="css/style.css" type="text/css">

		<title>torplay</title>
	</head>
	<body>
		<main id="app" class="hidden" :class="'show'">
			<section class="initializing" v-if="!server.isServerRunning">
				<div class="pad center">Intiallizing Media Delivery Server...</div>
			</section>

			<div v-else>
				<section class="playlist">
					<h1>Playlist</h1>

					<ul class="playlist is-blocks">
						<li v-if="!playlist.length">
							<div class="pad center">
								No media
							</div>
						</li>

						<li v-for="media,mIndex in playlist" v-else>
							<button class="is-block" :class="{active:currentPlaylistIndex==mIndex}" @click="selectMedia(mIndex)">
								<div class="flex">
									<div class="item-flex ellipsis-overflow v-center">
										<span>{{media.filename}}</span>

										<i class="material-icons light-grey small" v-if="media.subtitles.length">closed_caption</i>
									</div>

									<div class="pad-l">
										<a class="list-btn" @click.stop="console.log('test')">
											<i class="material-icons">edit</i>
										</a>
									</div>

									<div style="margin:-0.5em 0;" class="pad-l">
										<a class="list-btn red" @click.stop="removeMediaFromPlaylist(mIndex)">
											<i class="material-icons">cancel</i>
										</a>
									</div>
								</div>
							</button>
						</li>
					</ul>

					<div class="pad-t right">
						<button @click="overlayComponent='addTorrentMedia'">Add from torrent</button>
					</div>
				</section>

				<section class="device-control" v-if="currentMedia" :key="currentMedia.filename">
					<div class="flex">
						<div>
							<h1>Device Control</h1>
						</div>

						<div class="pad">
							<select v-model="currentDeviceName" @change="selectDevice($event.target.value)">
								<option v-for="name in deviceNames" :value="name">{{getFriendlyName(name)}}</option>
							</select>
						</div>

						<div>
							<button class="a" @click="refreshDevices()">
								<i class="material-icons grey">cached</i>
							</button>
						</div>
					</div>

					<div class="ellipsis-overflow">{{currentDeviceStatus}} ({{currentMedia ? currentMedia.filename : "no media selected"}})</div>

					<div v-if="currentDevice">
						<div v-if="!currentDevice.client">
							<button @click="playMedia(currentMedia)">launch media receiver</button>
						</div>
		
						<div v-else-if="isShowDeviceControls">
							<div>
								<input :disabled="isControlsDisabled" type="range" min="0" :max="currentMedia.duration" step="1" v-model="currentMedia.currentTime" @change="currentDevice.seekTo($event.target.value)">
							</div>

							<div class="flex">
								<div v-if="currentDeviceStatus=='PAUSED'">
									<button :disabled="isControlsDisabled" class="a" @click="currentDevice.resume()">
										<i class="material-icons large">play_circle</i>
									</button>
								</div>

								<div v-else>
									<button :disabled="isControlsDisabled" class="a" @click="currentDevice.pause()">
										<i class="material-icons large">pause_circle</i>
									</button>
								</div>

								<div>
									<button class="a" @click="closeDeviceConnection(currentDevice)">
										<i class="material-icons large">cancel</i>
									</button>
								</div>

								<div class="pad ellipsis-overflow">
									{{seconds2timecode(currentMedia.currentTime)}} / {{seconds2timecode(currentMedia.duration)}}
								</div>

								<!---label class="pad">
									playback rate:
									<select @change="currentDevice.setPlaybackRate($event.target.value)">
										<option selected>1</option>
										<option>1.5</option>
										<option>2</option>
										<option>5</option>
										<option>10</option>
									</select>
								</label--->

								<label class="pad" v-if="currentMedia.subtitles.length">
									cc:
									<select :disabled="isControlsDisabled" v-model="currentCcIndex">
										<option value="-1">off</option>
										<option v-for="cc,ccIndex in currentMedia.subtitles" :value="ccIndex">{{cc}}</option>
									</select>
								</label>
							</div>
						</div>
					</div>

					<div v-else>
						<video ref="vidEl" :src="getMediaDeliveryPath(currentMedia.filename,currentMedia.torrentUrl)" controls style="width:100%;" autoplay>
							<track v-for="subtitle in currentMedia.subtitles" :src="getMediaDeliveryPath(subtitle,currentMedia.torrentUrl)" :label="subtitle">
						</video>

						<div>
							<label v-if="currentMedia.subtitles.length">
								cc:
								<select @change="activateSubtitle($event.target.value)">
									<option value="-1">off</option>
									<option v-for="cc,ccIndex in currentMedia.subtitles" :value="ccIndex">{{cc}}</option>
								</select>
							</label>
						</div>
					</div>
				</section>

				<section class="overlay is-overlay" v-if="overlayComponent" @click.self="overlayComponent=false">
					<component :is="overlayComponent" class="overlay-component"></component>

					<button class="a overlay-close" @click="overlayComponent=false">
						<i class="material-icons small grey">close</i>
					</button>
				</section>
			</div>
		</main>

		<!--- components --->
		<script type="text/x-template" id="addTorrentMedia_template">
			<div class="add-torrent-media">
				<h1>Torrent:</h1>

				<div class="flex">
					<div class="item-flex has-dropdown">
						<input :disabled="busy" type="text" v-model="torrentUrl" @focus="isShowHistory=true" @blur="isShowHistory=false">

						<ul class="torrentUrl-history is-dropdown is-blocks" v-if="isShowHistory">
							<li v-for="url in torrentUrlHistory">
								<button class="is-block ellipsis-overflow" v-if="url" @mousedown="torrentUrl=url;getTorrentFileList(url)">
									{{url}}
								</button>
							</li>
						</ul>
					</div>

					<div>
						<button :disabled="busy" @click="getTorrentFileList(torrentUrl)">Load Torrent Files</button>
					</div>
				</div>

				<div class="pad-t">
					<ul class="torrent-files is-blocks">
						<li v-if="!torrentFiles.length">
							<div class="pad center">
								{{busy ? 'Loading files' : 'No torrent files loaded'}}
							</div>
						</li>
	
						<li v-for="file in _torrentFiles" v-else>
							<button class="is-block" @click="selectTorrentFile(file.name)" :class="{active:selectedTorrentFiles.indexOf(file.name)>-1}">
								<div class="flex">
									<div class="item-flex">
										{{file.name}}
									</div>
								</div>
							</button>
						</li>
					</ul>

					<div class="pad-t right">
						<button :disabled="!torrentFiles.length" @click="addAllTorrentFiles()">Add All</button>
						<button :disabled="!torrentFiles.length||!selectedTorrentFiles.length" @click="addSelectedTorrentFiles()">Add Selected</button>
						<button @click="$root.overlayComponent=false">Cancel</button>
					</div>
				</div>
			</div>
		</script>
	</body>
</html>
